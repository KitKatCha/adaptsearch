<?xml version="1.0"?>

<tool name="MutCount" id="mutcount" version="1.0">
    <description>
        This tool proceeds to count codons, amino acids on each species of a set of species, and then proceeds to permutation tests.
    </description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <requirements>
        <expand macro="python_required" />
    </requirements>

    <command>
    <![CDATA[
        #if str($method.method_run) == "concat" :
            python $__tool_directory__/scripts/S01a_mutcount_pairs.py $method.num_sampled $method.num_iter $method.list_species
            &&
            python $__tool_directory__/scripts/S02a_codon_counting.py ${method.concat_nuc} 
        #end if

        #if str($method.method_run) == "separated" :

            #if str($method.format.format_run)== "nucleic" :
                #set $infiles = ""
                #for $input in $method.format.sep_nuc
                    ln -s '$input' '$input.element_identifier';
                    #set $infiles = $infiles + $input.element_identifier + ","
                #end for
                #set $infiles = $infiles[:-1]

                python $__tool_directory__/scripts/S02b_study_seq_composition_nuc.py ${infiles}  ${method.format.concat_phy_nuc}                 
            #end if

            #if str($method.format.format_run)== "proteic" :
                #set $infiles = ""
                #for $input in $method.format.sep_aa
                    ln -s '$input' '$input.element_identifier';
                    #set $infiles = $infiles + $input.element_identifier + ","
                #end for
                #set $infiles = $infiles[:-1]

                cp $__tool_directory__/scripts/amino_acid_properties.csv .
                &&
                python $__tool_directory__/scripts/S01b_study_seq_composition_aa.py ${infiles} ${method.format.concat_phy_prot}               
            #end if
        #end if
    ]]>
    </command>

    <inputs>
        <conditional name="method">
            <param name="method_run" type="select" label="Which method do you want to use for this tool? ">
                <option value="concat">Concatenated genes in DNA (concatenation from RAxML run)</option>
                <option value="separated">Set of separated genes (from ORF_Search output "output zip containing files with CDS without indel")</option>
            </param>

            <when value="concat">
                <param name="concat_nuc" type="data" format="fasta" label="Choose your fasta file in nucleic format" help="It must contain the concatenated file in NUCLEIC format from Phylogeny tool" />
                <param name="num_sampled" type="integer" value="100" min="0" label="Number of iterations"/>
                <param name="num_iter" type="integer" value="100" min="0" label="Number of sampled codons"/>
                <param name="list_species" type="text" size="100" label="List of species" help="List the species separated with a comma (for e.g Ap,As,Ct,Gt,Yu)" />
            </when>

            <when value="separated">
                <conditional name="format"> 
                    <param name="format_run" type="select" label="Which format do you want to use for this tool (concatenation and RAxML run) ? ">
                        <option value="nucleic">Nucleic format</option>
                        <option value="proteic">Proteic format</option>
                    </param>

                    <when value="nucleic">
                        <param name="sep_nuc" type="data" format="fasta" multiple="true" label="Choose fasta files" help="Concatenated files in NUCLEIC format from ORF_search tool" />
                        <param name="concat_phy_nuc" type="data" format="fasta" label="Concatenated file from Phylogeny step" help="This file is used to retrieve the species names" />	
                    </when>

                    <when value="proteic">
                        <param name="sep_aa" type="data" format="fasta" multiple="true" label="Choose your ZIP file" help="Concatenated files in PROTEIC format from ORF_search tool" />
                        <param name="concat_phy_prot" type="data" format="fasta" label="concatenated file from Phylogeny step" help="This file is used to retrieve the species names" />
                    </when>	
                </conditional>
             </when>

        </conditional>
    </inputs>

    <outputs>
        <!-- output concat -->
        <data format="txt" name="output1" label="concatenated_results.txt" from_work_dir="codoncounting_results.txt" >
            <filter>(method['method_run']=='concat')</filter>
        </data>

        <!-- outputs separated - nucleic -->
        <data format="csv" name="nuc_comp" label="10_nuc_compositions.csv" from_work_dir="OUT/10_nuc_compositions.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'nucleic')</filter>
        </data>
        <data format="csv" name="percent_gc" label="11_percent_GC.csv" from_work_dir="OUT/11_percent_GC.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'nucleic')</filter>
        </data>
        <data format="csv" name="percent_pur" label="12_percent_purine.csv" from_work_dir="OUT/12_percent_purine.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'nucleic')</filter>
        </data>
        <data format="csv" name="purine_load" label="12_Purine_Load_Indice.csv" from_work_dir="OUT/12_Purine_Load_Indice.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'nucleic')</filter>
        </data>

        <!-- outputs separated - proteic -->
        <data format="csv" name="prot_comp" label="13_prot_compositions_All_AA.csv" from_work_dir="OUT/13_prot_compositions_All_AA.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="ivywrel" label="14_IVYWREL.csv" from_work_dir="OUT/14_IVYWREL.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="erk_dnqtsh" label="15_ERK_DNQTSH.csv" from_work_dir="OUT/15_ERK_DNQTSH.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="ek_qh" label="16_EK_QH.csv" from_work_dir="OUT/16_EK_QH.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="fymink_garp" label="17_FYMINK_GARP.csv" from_work_dir="OUT/17_FYMINK_GARP.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="avlimfyw" label="18_AVLIMFYW.csv" from_work_dir="OUT/18_AVLIMFYW.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="stnq" label="19_STNQ.csv" from_work_dir="OUT/19_STNQ.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="rhkde" label="20_RHKDE.csv" from_work_dir="OUT/20_RHKDE.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="payre_mvgds" label="21_PAYRE-MVGDS.csv" from_work_dir="OUT/21_PAYRE-MVGDS.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="res_weigth" label="22_TotalResidueWeight.csv" from_work_dir="OUT/22_TotalResidueWeight.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="res_vol" label="23_TotalResidueVolume.csv" from_work_dir="OUT/23_TotalResidueVolume.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="spec_vol" label="24_TotalPartialSpecificVolume.csv" from_work_dir="OUT/24_TotalPartialSpecificVolume.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>
        <data format="csv" name="hydrat" label="25_TotalHydratation.csv" from_work_dir="OUT/25_TotalHydratation.csv" >
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </data>

        <!--
        <collection name="output_sep_nuc" type="list" label="MutCount_Separated_Nucleic">
            <discover_datasets pattern="__name_and_ext__" directory="OUT" />
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'nucleic')</filter>
        </collection>        
        <collection name="output_sep_aa" type="list" label="MutCount_Separated_AminoAcids">
            <discover_datasets pattern="__name_and_ext__" directory="OUT" />
            <filter>(method['method_run']=='separated' and method['format']['format_run']== 'proteic')</filter>
        </collection>
        -->    
    </outputs>
    
    <tests>
        <test>
            <conditional name="method" >
                <param name="method_run" value="concat" />
                <param name="concat_nuc" ftype="fasta" value="test_07_output_phylogeny_concatenation.fasta" />
                <param name="num_sampled" value="100" />
                <param name="num_iter" value="100" />
                <param name="list_species" ftype="text" value="Ac,Pu,Am,Ap,Pf,Pg,Th,Ph,Te" />
            </conditional>
            <output name="output1">
                <assert_contents>
                    <has_text text="counting of Ac"/>
                    <has_text text="counting of Pu"/>
                    <has_text text="counting of Am"/>
                    <has_text text="counting of Ap"/>
                    <has_text text="counting of Pf"/>
                    <has_text text="counting of Pg"/>
                    <has_text text="counting of Th"/>
                    <has_text text="counting of Ph"/>
                </assert_contents>
            </output>
        </test>

        <test>
            <conditional name="method" >
                <param name="method_run" value="separated" />
                <conditional name="format" >
                    <param name="format_run" value="nucleic" />
                    <param name="sep_nuc" ftype="fasta" value="sep_nuc/locus1_sp6_sp6.fasta,sep_nuc/locus1_sp8_sp8.fasta,sep_nuc/locus2_sp6_sp6.fasta" />
                    <param name="concat_phy_nuc" ftype="fasta" value="phylogeny_concat.fasta" />
                </conditional>
            </conditional>
            <output name="nuc_comp" >
                <assert_contents>
                    <has_line line="locus1_sp8_sp8.fasta,0.29870,0.25541,0.19481,0.25108," />
                </assert_contents>
            </output>
            <output name="percent_gc">
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,42.70833," />
                </assert_contents>
            </output>
            <output name="percent_pur" >
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,56.77083," />
                </assert_contents>
            </output>
            <output name="purine_load" >
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,192,14,12,72.91667,62.50000," />
                </assert_contents>
            </output>
        </test>

        <test>
            <conditional name="method" >
                <param name="method_run" value="separated" />
                <conditional name="format" >
                    <param name="format_run" value="proteic" />
                    <param name="sep_aa" ftype="fasta" value="sep_aa/locus1_sp6_sp6.fasta,sep_aa/locus1_sp8_sp8.fasta,sep_aa/locus2_sp6_sp6.fasta" />
                    <param name="concat_phy_prot" ftype="fasta" value="phylogeny_concat.fasta" />
                </conditional>
            </conditional>
            <output name="prot_comp" >
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,0.12500,0.00000,0.09375,0.04688,0.03125,0.09375,0.03125,0.07812,0.00000,0.04688,0.01562,0.03125,0.03125,0.01562,0.04688,0.00000,0.07812,0.07812,0.06250,0.09375,0.12500,0.00000,0.09375,0.04688,0.03125,0.09375,0.01562,0.10938,0.00000,0.04688,0.01562,0.04688,0.01562,0.01562,0.04688,0.00000,0.07812,0.07812,0.06250,0.07812,0.12500,0.00000,0.09375,0.04688,0.04688,0.09375,0.01562,0.09375,0.00000,0.04688,0.01562,0.03125,0.01562,0.01562,0.04688,0.00000,0.07812,0.07812,0.06250,0.09375,0.14062,0.00000,0.09375,0.06250,0.04688,0.09375,0.01562,0.09375,0.00000,0.03125,0.01562,0.04688,0.01562,0.01562,0.03125,0.00000,0.07812,0.07812,0.06250,0.07812,0.12500,0.00000,0.12500,0.04688,0.03125,0.09375,0.01562,0.10938,0.00000,0.04688,0.01562,0.04688,0.01562,0.01562,0.04688,0.00000,0.07812,0.07812,0.06250,0.04688,0.14062,0.00000,0.09375,0.06250,0.04688,0.09375,0.01562,0.09375,0.00000,0.03125,0.01562,0.04688,0.01562,0.01562,0.03125,0.00000,0.07812,0.07812,0.06250,0.07812," />
                </assert_contents>
            </output>
            <output name="ivywrel">
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,21.00000,0.32812,23.00000,0.35938,23.00000,0.35938,22.00000,0.34375,23.00000,0.35938,22.00000,0.34375," />
                </assert_contents>
            </output>
            <output name="res_vol" >
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,6575.00000,6593.00000,6587.00000,6645.00000,6631.00000,6645.00000," />
                </assert_contents>
            </output>
            <output name="hydrat" >
                <assert_contents>
                    <has_line line="locus2_sp6_sp6.fasta,171.50000,171.50000,170.50000,171.00000,171.50000,171.00000," />
                </assert_contents>
            </output>
        </test>

        <!--
        <test>
            <conditional name="method" >
                <param name="method_run" value="separated" />
                <conditional name="format" >
                    <param name="format_run" value="nucleic" />
                    <param name="sep_nuc" ftype="fasta" value="sep_nuc/locus1_sp6_sp6.fasta,sep_nuc/locus1_sp8_sp8.fasta,sep_nuc/locus2_sp6_sp6.fasta" />
                    <param name="concat_phy_nuc" ftype="fasta" value="phylogeny_concat.fasta" />
                </conditional>
            </conditional>
            <output_collection name="output_sep_nuc" type="list" >
                <element name="10_nuc_compositions.csv" value="OUT_nuc/10_nuc_compositions.csv" />
                <element name="11_percent_GC.csv" value="OUT_nuc/11_percent_GC.csv" />
                <element name="12_percent_purine.csv" value="OUT_nuc/12_percent_purine.csv" />
                <element name="12_Purine_Load_Indice.csv" value="OUT_nuc/12_Purine_Load_Indice.csv" />
            </output_collection>
        </test>
        

        <test>
            <conditional name="method" >
                <param name="method_run" value="separated" />
                <conditional name="format" >
                    <param name="format_run" value="proteic" />
                    <param name="sep_aa" ftype="fasta" value="sep_aa/locus1_sp6_sp6.fasta,sep_aa/locus1_sp8_sp8.fasta,sep_aa/locus2_sp6_sp6.fasta" />
                    <param name="concat_phy_prot" ftype="fasta" value="phylogeny_concat.fasta" />
                </conditional>
            </conditional>
            <output_collection name="output_sep_aa" type="list" >
                <element name="13_prot_compositions_All_AA.csv" value="OUT_aa/13_prot_compositions_All_AA.csv" />
                <element name="14_IVYWREL.csv" value="OUT_aa/14_IVYWREL.csv" />
                <element name="15_ERK_DNQTSH.csv" value="OUT_aa/15_ERK_DNQTSH.csv" />
                <element name="16_EK_QH.csv" value="OUT_aa/16_EK_QH.csv" />
                <element name="17_FYMINK_GARP.csv" value="OUT_aa/17_FYMINK_GARP.csv" />
                <element name="18_AVLIMFYW.csv" value="OUT_aa/18_AVLIMFYW.csv" />
                <element name="19_STNQ.csv" value="OUT_aa/19_STNQ.csv" />
                <element name="20_RHKDE.csv" value="OUT_aa/20_RHKDE.csv" />
                <element name="21_PAYRE-MVGDS.csv" value="OUT_aa/21_PAYRE-MVGDS.csv" />
                <element name="22_TotalResidueWeight.csv" value="OUT_aa/22_TotalResidueWeight.csv" />
                <element name="23_TotalResidueVolume.csv" value="OUT_aa/23_TotalResidueVolume.csv" />
                <element name="24_TotalPartialSpecificVolume.csv" value="OUT_aa/24_TotalPartialSpecificVolume.csv" />
                <element name="25_TotalHydratation.csv" value="OUT_aa/25_TotalHydratation.csv" />
            </output_collection>
        </test>
        -->

    </tests>
    
    <help>

.. class:: infomark

**Authors**  Eric Fontanillas and Pierre-Guillaume Brun creates the scripts of this pipeline.

.. class:: infomark

**Galaxy integration** Julie Baffard and ABIMS TEAM

 | Contact support.abims@sb-roscoff.fr for any questions or concerns about the Galaxy implementation of this tool.

---------------------------------------------------


========
Mutcount
========

-----------
Description
-----------


This script counts the number of codons, amino acids, and types of amino acids in sequences, as well as the mutation bias from one item to another between 2 sequences.
Counting is then compared to empirical p-values, obtained from bootstrapped sequences obtained from a subset of sequences
     
In the output files, the pvalues indicate the position of the observed data in a distribution of empirical countings obtained from a resample of the data. Values above 0.95 indicate a significantly higher counting, values under 0.05 a significantly lower counting

the script automatically reads the sequences to compare from a file that must be called pairs.txt and located with the .fasta file
in the pairs.txt file, sequences (let's assume X, Y, Z, U, V) pairs must be written as 'X Y\nU V\nZ V'
in this case, codoncounting will count the occurence of codons, amino acids, and types of amino acids in X, U, Z, and count the mutation bias from Y to X, V to U and V to Z
you can add comments in the pairs.txt file inbetween lines, beginning with '#'. E.G. 'X Y\n#This is my comment\nU V\nZ V'
X, Y, Z, U, V must be character strings contained in the sequences names in the .fasta file (and be specific to each of them)
     in pairs.txt, you must write how should be built the bootstrapped resampling of sequences. This must be formated as:'X Y\nbackground: length iterration plusminus listofspecies\nU V\nZ V', explanation below
     backgrounds must be excplicitely written in the pairs.txt file (the script still integers default parameters). This implies that the first line of pairs.txt should be a background line
     by default, once the background has been determined, it will be applied to each subsequent analysis until another background is written
     e.g. 'background: length1 iterration1 plusminus1 listofspecies1\nU V\nZ V\nbackground: length2 iterration2 plusminus2 listofspecies2\nX Y' the first background is applied to U V and Z V and the 2nd background to X Y


#the script resamples random pairs of aligned codon to determine what countings can be expected under the hypothesis of an homogenous dataset
#countings are performed on each generated random alignement, thousands of alignments allow to draw a gaussian distribution of the countings
#then the script simply checks whether the observed data are within the 5% lowest or 5% highest values of the distribution
     in background: length iterration plusminus listofspecies
     -&gt; length is the number of pairs of codons in each generated alignments (effect on the robustness on the countings performed on this alignement)
     -&gt; iterration is the number of alignments that will be generated (effect on the resolution of the gaussian distribution)
     -&gt; plusminus can be either '+' or '-', '+' indicates that the following species only must be resampled, '-' that the following species must be excluded from the resampling
     -&gt; listofspecies is the list of species (names contained in the sequences names from the fasta file) that must be included or excluded from the sampling. You can also write 'all' to include every species (in this case, plusminus parameter is ignored)
     #full example: background 5000 10000 + melanogaster elegans sapiens
iterration shouldn't be lower that 1000 to have a relatively smooth gaussian distribution, length shouldn't be lower as 1000 to detect codons with relatively low occurence (&lt;1%)
for the list of species, you can try to form subgroups depending on the studied parameter (e.g. comparing a terrestrial species with a background composed of marine species)



.. class:: infomark


**Important part of this tool (the inputs format)**

--------

============
Input format
============

The script takes as input the DNA alignment (fasta format): python codoncounting.py file_path.fasta

example.

    </help>
    
    <expand macro="citations" />

</tool>

