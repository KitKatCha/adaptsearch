<tool name="OrthoGroups" id="orthogroups" version="1.0">

	<description>
		This tool takes TransDecoder outputs and find orthologous groups with OrthoFinder. Then, it proceeds to retrieve sequences back and write each orthogroups in its own fasta file.
	</description>	

	<requirements>
		<requirement type="package" version="2.7">python</requirement>		
		<requirement type="package" version="1.1.2">orthofinder</requirement>
	</requirements>
	
  	<command>
	<![CDATA[
		./$__tool_directory__/scripts/format_headers.sh	

		#set $infiles = ""
        #for '$input' in $inputs_fasta
            ln -s '$input' '$input.element_identifier';
            #set $infiles = $infiles + $input.element_identifier + ","
        #end for
        #set $infiles = $infiles[:-1]				
		
		orthofinder -f '$infiles' -t \${GALAXY_SLOTS:-16} -a \${GALAXY_SLOTS:-16} -I ${inflation}
		#if $only_groups == "Yes" :
			-og
		#end if

		mv Results_* results
		
		python $__tool_directory__/scripts/filter_orthofinder.py results/orthogroups.txt ${nbseq} > ${output}
	]]>
  	</command>

 	<inputs>		
		<param name="inputs_fasta" type="data" format="fasta" multiple="true" label="Input_files" />
		<pram name="nbseq" type="integer" value="3" label="Minimal number of sequences per orthogroup" help="Drop orthogroups with less than x sequences :" />
		<param name="inflation" type="float" value="1.5" label="Inflation parameter" help="Specify a non-default inflation parameter for MCL. Not recommended. [Default is 1.5]" />
		<param name="only_groups" type="select" label="Only infer orthogroups, do not infer gene trees of orthologues." >
			<option value="yes">Yes</option>
			<option value="no">No</option>
		</param>
		<param name="rootedSpeciesTree" type="select" label=" Use rootedSpeciesTree for gene-tree/species-tree reconciliation (i.e. orthologue inference)." >
			<option value="no">No</option>
			<option value="yes">Yes</option>			
		</param>
	</inputs>

	<outputs>
		<data format="txt" name="output" label="Orthogroups_summary" />
		<data format="txt" name="orthogroups1" label="Orthogroups.txt" />
		<data format="csv" name="orthogroups2" label="Orthogroups.csv"/>
		<data format="csv" name="specs_overlap" label="Orthogroups_SpeciesOverlaps.csv" from_work_dir="results" >
			<filter>only_groups == "Yes"</filter>
		</data>
		<data format="csv" name="unassigned_genes" label="Orthogroups_UnassignedGenes.csv" from_work_dir="results" >
			<filter>only_groups == "Yes"</filter>
		</data>
		<data format="csv" name="stat_overall" label="Statistics_Overall.csv" from_work_dir="results" >
			<filter>only_groups == "Yes"</filter>
		</data>
		<data format="csv" name="stat_specs" label="Statistics_PerSpecies.csv" from_work_dir="results" >
			<filter>only_groups == "Yes"</filter>
		</data>	
		<collection name="orthogroups_fasta" type="list" label="Orthogroups_fasta_files" >
            <discover_datasets pattern="__name_and_ext__" directory="filtered_orthogroups" />
        </collection>
        <collection name="orthogroups_fasta" type="list" label="Orthogroups_fasta_files">
            <discover_datasets pattern="__name_and_ext__" directory="Orthologues_" />
            <filter>full_results == "Yes"</filter>
        </collection>
	</outputs>

	<tests>
		<test>
			<param name="inputs_fasta" />
			<param name="nbseq" value="3" />
			<param name="inflation" value="1.5" />
			<param name="only_groups" value="yes" />
			<output name="output" value="test_tool.out" />
		</test>
	</tests>	

	<help>
==========
OrthoGroups
==========

This tool infers groups of orthologs genes (e.g. orthogroups) within a set of species, using OrthoFinder. It proceeds to write each orthogroup into separated fasta files.

| I-Pre-treatment

| .. class:: warningmark

This tool is configured to work within the AdaptSearch toolsuite, which implies a specific format of headers. Indeed, the input files are outputs from TransDecoder
(a tool which translates nucleic sequences in proteic sequences). Thus, headers are initially formatted like this :
| &gt;m.144 g.144  ORF g.144 m.144 type:internal len:123 (+) Pf1004_1/1_1.000_369:1-372(+)
| A pre-treatment rewrites all the header in order to have IDs under this form :
| &gt;Pf1004_1/1_1.000_369

| II-Orthofinder

| OrthoFinder is a fast, accurate and comprehensive analysis tool for comparative genomics. It finds orthologues and orthogroups infers gene trees for all orthogroups and infers a rooted species tree for the species being analysed. OrthoFinder also provides comprehensive statistics for comparative genomic analyses. 

| Emms, D.M. and Kelly, S. (2015) OrthoFinder: solving fundamental biases in whole genome comparisons dramatically improves orthogroup inference accuracy, Genome Biology 16:157

| Our tool focus on the orthogroups.txt file created before gene trees. The user can also, if we wants to, get the whole results of Orthofinder (option "full results").

III-Post-treatment : writing orthogroups in fasta files

A final script proceeds to split each orthogroup in its own fasta file and, with the use of the output of Filter_Assembleis, to re-associate each ID with its sequence.

---------------------
inputs and parameters
---------------------

| - Input : A dataset collection of fasta files (one file per species), proteic format (outputs from TransDecoder)
| - Minimal number of sequences : The orthogroups with less than the specified number won't be recorded. Thanks to the paralogous filtering, the number of sequences within an orthogroup is equivalent to the number of species.

-------
Outputs
-------

- Orthogroups_summary : a short file counting the number of species and sequences in orthogroups.
- Orthogroups.txt / csv : the files containing orthogroups.
- Statistics files : at csv format

	</help>

	<citations>
		<citation type="bibtex">Credits : ABIMS team, Roscoff Marine Station</citation>
		<citation type="bibtex">Contact support.abims@sb-roscoff.fr for any questions or concerns about the Galaxy implementation of this tool.</citation>
		<citation type="bibtex">Author : Victor Mataigne -- Galaxy integration : Gildas Le Corguillé and Victor Mataigne.</citation>		
	</citations>

</tool>
