<tool name="OrthoFinder" id="orthofinder" version="1.0">

	<description>
		OrthoFinder is a fast, accurate and comprehensive analysis tool for comparative genomics. It finds orthologues and orthogroups infers gene trees for all orthogroups and infers a rooted species tree for the species being analysed
	</description>	

	<requirements>
		<requirement type="package" version="2.7">python</requirement>		
		<requirement type="package" version="1.1.4">orthofinder</requirement>
	</requirements>
	
  	<command>
	<![CDATA[
		
		#set $infiles = ""
        #for '$input' in $inputs_fasta
            ln -s '$input' '$input.element_identifier';
            #set $infiles = $infiles + $input.element_identifier + ","
        #end for
        #set $infiles = $infiles[:-1]				
		
		orthofinder -f '$infiles' -t \${GALAXY_SLOTS:-1} -a \${GALAXY_SLOTS:-1} -I ${inflation}
		#if $options.start_and_end.value == "blast_results":		
			-b $__tool_directory__/
		#else if $start_and_end == "from_groups":
			-fg
		#else if $start_and_end == "from_trees":
			-ft
		#end if
		
		#if $only_groups == "yes" :
			-og
		#end if

		mv $__tool_directory__/Results_* $__tool_directory__/results
		mv $__tool_directory__/results/Orthologues_* $__tool_directory__/results/orthologues		
	]]>	
  	</command>

 	<inputs>		
		<param name="inputs_fasta" type="data" format="fasta" multiple="true" label="Input_files from TransDecoder" />		

		<conditonal>
			<param name="options" type="select" label="Use options ?" >
				<option value="yes">Yes</option>
				<option value="no" selected="true">No</option>
			</param>
			<when value="yes">
				<conditional>
					<param name="start_and_end" type="select" label="Control where analysis starts/finishes:" >
						<option value="blast_results">Predict orthogroups using pre-calculated BLAST results</option>
						<option value="from_groups">Infer gene trees and orthologues starting from pre-computed orthogroups</option>
						<option value="from_trees">Infer orthologues starting from pre-computed gene trees</option>
					</param>
					<when value="blast_results">
						<!-- Ici ça ne va pas : ces paramètres peuvent être utilisés même quand on règle pas les options -->
						<!-- Il faut trouver le moyen de faire intervenir ces paramètres pour le cas général ET dans le cas de l'utilsiation de l'option blast_results -->
						<param name="inflation" type="float" value="1.5" label="Inflation parameter" help="Modify inflation parameter for MCL. Not recommended. [Default : 1.5]" />
						<param name="only_groups" type="select" label="Only groups" help="Only infer orthogroups, do not infer gene trees of orthologues." >
							<option value="yes">Yes</option>
							<option value="no" selected="true">No</option>
						</param>						
					</when>
				</conditional>
			</when>
			<when value="no">
				<param name="only_prepare" type="select" label="Only prepare" help="Only prepare the BLAST input files in the format required by OrthoFinder. Incompatible with all the other options." >
					<option value="yes">Yes</option>
					<option value="no" selected="true">No</option>
				</param>
			</when>
		</conditonal>

		<!-- Paramètres pas encore résolus
		 
		<param name="rootedSpeciesTree" type="select" label=" Use rootedSpeciesTree for gene-tree/species-tree reconciliation (i.e. orthologue inference)." >
			<option value="no">No</option>
			<option value="yes">Yes</option>			
		</param>
		-->
	</inputs>

	<outputs>		
		<data format="txt" name="orthogroups1" label="Orthogroups.txt" />
		<data format="csv" name="orthogroups2" label="Orthogroups.csv"/>
		<data format="csv" name="specs_overlap" label="Orthogroups_SpeciesOverlaps.csv" from_work_dir="results" />			
		<data format="csv" name="unassigned_genes" label="Orthogroups_UnassignedGenes.csv" from_work_dir="results" />			
		<data format="csv" name="stat_overall" label="Statistics_Overall.csv" from_work_dir="results" />			
		<data format="csv" name="stat_specs" label="Statistics_PerSpecies.csv" from_work_dir="results" />
		
        <collection name="orthogroups_fasta" type="list" label="Orthogroups_fasta_files">
            <discover_datasets pattern="__name_and_ext__" directory="results/orthologues" />
            <filter>only_groups == "no"</filter>
        </collection>
	</outputs>

	<tests>
		<test>
			
		</test>
	</tests>	

	<help>
===========
OrthoFinder
===========

	</help>

	<citations>
		<citation type="bibtex">https://github.com/davidemms/OrthoFinder</citation>
		<citation type="bibtex">Emms, D.M. and Kelly, S. (2015) OrthoFinder: solving fundamental biases in whole genome comparisons dramatically improves orthogroup inference accuracy, Genome Biology 16:157</citation>		
	</citations>

</tool>
